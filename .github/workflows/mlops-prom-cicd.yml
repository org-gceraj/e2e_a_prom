name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  # =============================
  # JOB 1: Build & Push Images
  # =============================
#  build:
#    name: Build & Push to DockerHub
#    runs-on: ubuntu-latest
#
#    env:
#      FASTAPI_HOST: ${{ vars.FASTAPI_HOST }}
#      STREAMLIT_HOST: ${{ vars.STREAMLIT_HOST }}
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Login to DockerHub
#        uses: docker/login-action@v2
#        with:
#          username: ${{ secrets.DOCKER_USERNAME }}
#          password: ${{ secrets.DOCKER_PASSWORD }}
#
#      - name: Build and Push Image
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          file: ./docker/prom.dockerfile
#          push: true
#          tags: ${{ secrets.DOCKER_USERNAME }}/e2e_v1-prom:1.1
#
 # =============================
 # JOB 2: Deploy to EC2
 # =============================
  deploy:
    name: Deploy to EC2
#    needs: build
    runs-on: ubuntu-latest

    env:
      ACTIONS_STEP_DEBUG: true
      ACTIONS_RUNNER_DEBUG: true

    steps:
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ls -ltra ~
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
        echo "${{ vars.EC2_PROM_SSH_KEY }}"| tr -d '\r' > ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys
        ssh-keyscan -H ${{ vars.EC2_PROM_HOST }} >> ~/.ssh/known_hosts
        ls -ltra ~/.ssh/

    - name: Debug SSH Connection
      run: |
        ssh -i ~/.ssh/id_rsa ${{ vars.EC2_PROM_USER }}@${{ vars.EC2_PROM_HOST }} "echo connected"
    
    - name: Deploy
      run: |
        ssh -i ~/.ssh/id_rsa ${{ vars.EC2_PROM_USER }}@${{ vars.EC2_PROM_HOST }} "whoami"
  
#    steps:
#      - name: Deploy via SSH
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          debug: true
#          host: ${{ secrets.EC2_PROM_HOST }}
#          username: ${{ secrets.EC2_PROM_USER }}
#          key: ${{ secrets.EC2_PROM_SSH_KEY }}
#          script_stop: true
#          script: |
#            whoami
#            pwd
#            ls -la
#            docker pull ${{ secrets.DOCKER_USERNAME }}/e2e_v1-prom:1.1
#            docker stop e2e_v1-prom || true
#            docker rm e2e_v1-prom || true
#            docker run -d --name e2e_v1-prom -p 9090:9090 ${{ secrets.DOCKER_USERNAME }}/e2e_v1-prom:1.1


#  deploy:
#    runs-on: ubuntu-latest
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Set up SSH
#      run: |
#        mkdir -p ~/.ssh
#        echo "${{ secrets.EC2_PROM_SSH_KEY }}" > ~/.ssh/id_rsa
#        chmod 600 ~/.ssh/id_rsa
#        ssh-keyscan -H ${{ secrets.EC2_PROM_HOST }} >> ~/.ssh/known_hosts
#
#    - name: Copy project to EC2
#      run: |
#        rsync -avz --delete \
#          -e "ssh -i ~/.ssh/id_rsa" \
#          ./ ${{ secrets.EC2_PROM_USER }}@${{ secrets.EC2_PROM_HOST }}:${{ secrets.EC2_APP_DIR }}
#
#    - name: Deploy on EC2
#      run: |
#        ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_PROM_USER }}@${{ secrets.EC2_PROM_HOST }} << 'EOF'
#          cd ${{ secrets.EC2_PROM_APP_DIR }}
#
#          docker pull ${{ secrets.DOCKER_USERNAME }}/e2e_v1-prom:1.1
#          docker stop e2e_v1-prom || true
#          docker rm e2e_v1-prom || true
#          docker run -d --name e2e_v1-prom -p 9090:9090 ${{ secrets.DOCKER_USERNAME }}/e2e_v1-prom:1.1
#        EOF
#